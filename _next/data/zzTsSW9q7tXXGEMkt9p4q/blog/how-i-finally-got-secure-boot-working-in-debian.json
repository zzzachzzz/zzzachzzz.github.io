{"pageProps":{"post":{"title":"How I Finally Got Secure Boot Working in Debian","date":"2025-12-26T14:18:15.800Z","content":"\n![sudo mokutil --sb-state SecureBoot enabled](/assets/secure-boot-enabled-mokutil.jpg)\n\nTL;DR: [How I Did It](#how-i-did-it)\n\n## Intro\n\nSecure boot is actually pretty well supported on Debian and other major distros. But complications can arise when:\n\n1. Enabling secure boot later, not during a clean install of the OS\n2. Using a non-default bootloader (default is typically GRUB)\n3. Having multiple bootloaders installed\n\nAll of the above applied to my situation, making it hard mode.\n\n## Background on My Weird Setup\n\nI was single booting Arch + systemd-boot for a while.\n\nThen I adapted this setup to dual boot Arch & Debian via multiple systemd-boot boot entries.\n\nWhen Debian was installed, GRUB got installed too, somehow, despite reusing my boot partition and specifically trying to avoid this.\n\nLater I removed the Arch installation, and switched to dual booting Debian & Windows. (through multiple UEFI boot entries, couldn't quite get it working to launch Windows from systemd-boot)\n\nI enabled secure boot for a Windows game (League of Legends Vanguard anti-cheat...).\n\nNow, the problem motivating me to get secure boot working on Debian:\n**I can't boot Debian without first disabling secure boot**\n\n## Terminology\n\n- **UEFI/NVRAM boot entries** : Boot entries in motherboard menu (firmware level shit) (`Boot0001`, `Boot0002`, etc.)\n- **Bootloader** : Software (systemd-boot, GRUB) that loads the OS kernel, acting as the bridge between firmware (UEFI/BIOS) and the OS\n- **[UEFI (Unified Extensible Firmware Interface)](https://wiki.archlinux.org/title/Unified_Extensible_Firmware_Interface)** : Modern firmware standard for motherboards, successor to legacy BIOS\n- **EFI (Extensible Firmware Interface)** : `.efi` files are UEFI executables, typically bootloaders and shims, placed on the boot partition\n- **[ESP (EFI System Partition)](https://wiki.archlinux.org/title/EFI_system_partition)** : OS-independent boot partition for UEFI (typically mounted at `/boot`)\n- **Shim** : An alternative method of managing accepted Secure Boot keys without touching the UEFI firmware settings. In its simplest configuration, shim will just chainload any EFI executable.\n- **Trixie** : Debian 13 Trixie (stable release at time of writing)\n- **Bookworm** : Debian 12 Bookworm (oldstable release at time of writing)\n\n## Debian Docs and Shim Explained\n\nI was hopeful when I found this excerpt from the Debian Wiki:\n\n> Starting with Trixie, users of Debian (and of the Debian Installer, since Trixie RC3) can optionally choose to use systemd-boot with shim. The integration point is the systemd-boot package and its postinst/prerm scripts. If GRUB packages are not installed, and both the shim-signed and systemd-boot-efi-[amd64|arm64]-signed packages are installed, then the maintainer scripts will run logic to install the appropriate EFI binaries to the ESP, and to add an EFI boot entry (named Debian) pointing to shim and making it the default entry. If either or both packages are removed, this logic runs in reverse and completely removes the binaries from the ESP, and deletes the EFI boot entry.\n\n[Secure Boot setup with systemd-boot - Debian Wiki](https://wiki.debian.org/SecureBoot#Secure_Boot_setup_with_systemd-boot)\n\n> shim is a simple software package that is designed to work as a first-stage bootloader on UEFI systems.\n>\n> It was developed by a group of Linux developers from various distros, working together to make Secure Boot work using Free Software. It is a common piece of code that is safe, well-understood and audited so that it can be trusted and signed using platform keys. This means that Microsoft (or other potential firmware CA providers) only have to worry about signing shim, and not all of the other programs that distro vendors might want to support.\n\n[Shim - Debian Wiki](https://wiki.debian.org/SecureBoot#Shim)\n\nIn other words, the default secure boot keys on your motherboard firmware that work for Windows secure boot will also work for the shim secure boot. This makes it so you don't have to configure custom, non-standard secure boot keys in your motherboard firmware (UEFI).\n\nNote... shim is not a security bypass that allows secure booting of any arbitrary unsigned EFI. It \"Enforces signature verification on whatever it chainloads\".\n\n```\nUEFI firmware\n  -> shimx64.efi (Microsoft-signed shim)\n     -> verifies next EFI binary (systemd-bootx64.efi, grubx64.efi)\n        -> launches it if trusted (Linux kernel)\n```\n\n## How I Did It\n\n**Follow the instructions: [Secure Boot setup with systemd-boot - Debian Wiki](https://wiki.debian.org/SecureBoot#Secure_Boot_setup_with_systemd-boot)**\n\nIn the sections that follow, I'll explain where I found the docs lacking, and more detail on what I did.\n\n### Why It Was Not Working (Insofar as I Can Tell)\n\nI tried following the instructions outlined in the Debian Wiki, and I found them difficult to understand.\n\nI suspect there's one of two reasons it didn't work for me initially...\n\n#### Reason 1: Missing `systemd-boot-efi-[amd64|arm64]-signed`\n\nI did not first install `systemd-boot-efi-[amd64|arm64]-signed` as instructed:\n\n> If GRUB packages are not installed, and both the shim-signed and systemd-boot-efi-[amd64|arm64]-signed packages are installed, then the maintainer scripts will run logic to install the appropriate EFI binaries to the ESP...\n\nI'm not really sure why the command to install this is not explicitly included with the other `apt` commands in the doc's code blocks. But I addressed this with:\n\n```bash\nsudo apt install --reinstall shim-signed systemd-boot-efi-amd64-signed\n```\n\n#### Reason 2: Leftover GRUB\n\nMaybe I did not do a thorough enough purging of leftover GRUB?\n\n> A user wanting to switch from GRUB to systemd-boot should do so by removing the GRUB packages and installing systemd-boot at the same time, for example on an amd64 system:\n> `# apt install --allow-remove-essential systemd-boot grub-efi-amd64-signed-`\n\nFor good measure I did the following to fully remove GRUB:\n\n```bash\n# Find all grub packages\napt list --installed | grep -i grub\n# Remove em. Your packages may vary, these were mine.\nsudo apt purge grub-common grub-efi-amd64-bin grub-efi-amd64-unsigned grub-efi-amd64 grub2-common\n# Other grub artifacts removed\n# Enter root session `sudo -i` and `cd /boot` partition\nfind . -iname '*grub*'\nrm -r ./grub/\n```\n\n## Additional Info\n\n### Cleaning Up Pre-Shim systemd-boot EFIs\n\nWhen I reinstalled one of the systemd-boot packages (probably `systemd-boot`, don't remember), I got a message about these files already being present:\n\n- `/boot/efi/EFI/systemd/systemd-bootx64.efi`\n- `/boot/efi/EFI/BOOT/BOOTX64.EFI`\n\nOut of an abundance of caution, I first removed the `.efi` files (perhaps you should back them up somewhere):\n```bash\nsudo rm /boot/efi/EFI/systemd/systemd-bootx64.efi /boot/efi/EFI/BOOT/BOOTX64.EFI\n```\n\nAnd then I reinstalled said systemd-boot packages, just to be sure that the `.efi` files were signed, postinst scripts ran correctly, etc.\n\n### Commands for: `efibootmgr - change the UEFI Boot Manager configuration`\n\nSee: `man efibootmgr`\n\nUsing `efibootmgr -v`, you can see the UEFI boot entries (`Boot0001`, `Boot0002`, etc.).\n\nYou can supposedly delete boot entries through this interface, but this didn't work for me. I think this only deactivated/disabled boot entries: `sudo efibootmgr -b 0004 -B`\n\nAlternatively you can disable unwanted entries in your motherboard's UEFI menu.\n\n### Set Default systemd-boot Entry to Current\n\nOnce you have booted into the right systemd-boot entry:\n\n```bash\nsudo bootctl set-default @current\n```\n\n### Verify Secure Boot Enabled From Linux\n\n```bash\n$ sudo mokutil --sb-state\nSecureBoot enabled\n```\n\n### Get Info From `bootctl status`\n\n`sudo bootctl status` ouputs lots of info such as:\n\n```\nSystem:\n      Firmware: UEFI 2.70 (American Megatrends 5.19)\n Firmware Arch: x64\n   Secure Boot: enabled (user)\n  TPM2 Support: yes\n  Measured UKI: no\n  Boot into FW: supported\n\n...\n\nAvailable Boot Loaders on ESP:\n          ESP: /boot/efi (/dev/disk/by-partuuid/d64202ea-8de9-47d6-947c-11122d0ba571)\n         File: ├─/EFI/systemd/systemd-bootx64.efi (systemd-boot 257.9-1~deb13u1)\n               ├─/EFI/BOOT/BOOTX64.efi\n               └─/EFI/BOOT/fbx64.efi\n\n...\n\nBoot Loaders Listed in EFI Variables:\n        Title: Debian\n           ID: 0x0003\n       Status: active, boot-order\n    Partition: /dev/disk/by-partuuid/d64202ea-8de9-47d6-947c-11122d0ba571\n         File: └─EFI/DEBIAN/SHIMX64.EFI\n\n... and more!\n```\n\n","slug":"how-i-finally-got-secure-boot-working-in-debian"}},"__N_SSG":true}
<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Going Truly Serverless with Next.js Static Site Generation</title><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/116a9d0d7bbcb7ff8fb6.css" as="style"/><link rel="stylesheet" href="/_next/static/css/116a9d0d7bbcb7ff8fb6.css" data-n-p=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-c746a4ce4ff8692382cd.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.37f4a736348214b3ca94.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.e810983d220ce60d77fa.js" as="script"/><link rel="preload" href="/_next/static/chunks/d31217defe14a45f21f2dc88a0340a4400241e5c.43128fe35357df1292f1.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-c5083ace283475b900f0.js" as="script"/><link rel="preload" href="/_next/static/chunks/f55490c27d84c973f151130575d86126183b0b6b.3b39966ad3ab6ba53dac.js" as="script"/><link rel="preload" href="/_next/static/chunks/14e8b4443f853547963f3fff4f6d87edb6a6aabe.7f99b8b5b085a064ffe9.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/blog/%5Bslug%5D-3e90714ce7440c4a9cbd.js" as="script"/><style data-styled="" data-styled-version="5.2.1">html{font-size:16px;min-height:100vh;}/*!sc*/
html,body{height:100%;margin:0;padding:0;}/*!sc*/
@media only screen and (max-device-width:480px){html{font-size:14px;}}/*!sc*/
body{background-color:#3e4d4f;color:white;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Roboto","Oxygen", "Ubuntu","Cantarell","Fira Sans","Droid Sans","Helvetica Neue", sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}/*!sc*/
*{box-sizing:border-box;}/*!sc*/
h1,h2,h3,h4,h5,h6{font-weight:400;}/*!sc*/
code{font-family:Consolas,Monaco,'Andale Mono','Ubuntu Mono',monospace;}/*!sc*/
data-styled.g1[id="sc-global-bYaKAX1"]{content:"sc-global-bYaKAX1,"}/*!sc*/
.kuhBS{background-color:#272822;font-family:Consolas,Monaco,'Andale Mono','Ubuntu Mono',monospace;padding:0.2em 0.4em;font-size:0.8em;border-radius:0.3em;color:#ae81ff;-webkit-text-decoration:none;text-decoration:none;}/*!sc*/
data-styled.g2[id="A__A_-sc-14fqd0c-0"]{content:"kuhBS,"}/*!sc*/
.frqqeo{margin:5px;}/*!sc*/
data-styled.g3[id="Navigation___StyledLink-sc-10fffhi-0"]{content:"frqqeo,"}/*!sc*/
.fBDDkv{margin:5px;}/*!sc*/
data-styled.g4[id="Navigation___StyledLink2-sc-10fffhi-1"]{content:"fBDDkv,"}/*!sc*/
.gwcSSF{margin:5px;}/*!sc*/
data-styled.g5[id="Navigation___StyledLink3-sc-10fffhi-2"]{content:"gwcSSF,"}/*!sc*/
.hmTGJm{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;font-size:1.2em;-webkit-text-decoration:none;text-decoration:none;}/*!sc*/
data-styled.g6[id="Navigation__Nav-sc-10fffhi-3"]{content:"hmTGJm,"}/*!sc*/
.kjdbIE{margin:5px;color:white;font-weight:500;line-height:1;}/*!sc*/
data-styled.g7[id="Navigation___StyledSpan-sc-10fffhi-4"]{content:"kjdbIE,"}/*!sc*/
.iQzkww{background-color:#272822;font-family:Consolas,Monaco,'Andale Mono','Ubuntu Mono',monospace;padding:0.2em 0.4em;font-size:0.8em;border-radius:0.3em;}/*!sc*/
data-styled.g17[id="Code-sc-1amjnp4-0"]{content:"iQzkww,"}/*!sc*/
.fOgHwq{margin-left:auto !important;margin-right:auto !important;}/*!sc*/
data-styled.g18[id="TreeToJSX__Pre-sc-1taxolb-0"]{content:"fOgHwq,"}/*!sc*/
.dTmJnK > p{margin:0;}/*!sc*/
data-styled.g20[id="TreeToJSX__Li-sc-1taxolb-2"]{content:"dTmJnK,"}/*!sc*/
.jvwBiV{width:100%;height:100%;object-fit:contain;display:block;}/*!sc*/
data-styled.g21[id="TreeToJSX__Img-sc-1taxolb-3"]{content:"jvwBiV,"}/*!sc*/
.hYmhcO{text-align:center;margin:2em;margin-bottom:0.2em;}/*!sc*/
data-styled.g23[id="slug___StyledH-sc-8mhdoa-0"]{content:"hYmhcO,"}/*!sc*/
.iRnBGj{font-size:0.9em;text-align:center;}/*!sc*/
data-styled.g24[id="slug___StyledP-sc-8mhdoa-1"]{content:"iRnBGj,"}/*!sc*/
.bWFbvA{font-size:1.2em;line-height:1.4em;-webkit-letter-spacing:0.01em;-moz-letter-spacing:0.01em;-ms-letter-spacing:0.01em;letter-spacing:0.01em;overflow-wrap:break-word;padding:1.1em;margin:0 auto;}/*!sc*/
.bWFbvA > *:not(pre){max-width:850px;margin-left:auto;margin-right:auto;}/*!sc*/
.bWFbvA > pre{width:90vw;max-width:1100px;}/*!sc*/
data-styled.g25[id="slug__BlogContentContainer-sc-8mhdoa-2"]{content:"bWFbvA,"}/*!sc*/
</style></head><body><div id="__next"><div><nav class="Navigation__Nav-sc-10fffhi-3 hmTGJm"><a href="/" target="_self" rel="noopener noreferrer" class="A__A_-sc-14fqd0c-0 kuhBS Navigation___StyledLink-sc-10fffhi-0 frqqeo">/</a><span class="Navigation___StyledSpan-sc-10fffhi-4 kjdbIE">&gt;</span><a href="/blog" target="_self" rel="noopener noreferrer" class="A__A_-sc-14fqd0c-0 kuhBS Navigation___StyledLink2-sc-10fffhi-1 fBDDkv">blog</a><span class="Navigation___StyledSpan-sc-10fffhi-4 kjdbIE">&gt;</span><a href="/blog/going-truly-serverless-with-nextjs-static-site-generation" target="_self" rel="noopener noreferrer" class="A__A_-sc-14fqd0c-0 kuhBS Navigation___StyledLink3-sc-10fffhi-2 gwcSSF">going-truly-serverless-with-nextjs-static-site-generation</a></nav><main><header><h1 class="slug___StyledH-sc-8mhdoa-0 hYmhcO">Going Truly Serverless with Next.js Static Site Generation</h1><p class="slug___StyledP-sc-8mhdoa-1 iRnBGj"><time dateTime="2021-02-20T14:35:05.888Z">February 20, 2021</time></p></header><article><div class="slug__BlogContentContainer-sc-8mhdoa-2 bWFbvA"><p>With the hype of the <a href="https://jamstack.org" target="_blank" rel="noopener noreferrer" class="A__A_-sc-14fqd0c-0 kuhBS">Jamstack</a>, and the benefits it offers, I made the switch from MERN stack to JAM stack for my blog. The most appealing benefits to me in my use case were:</p><ol><li class="TreeToJSX__Li-sc-1taxolb-2 dTmJnK"><p>Improved SEO, for my site that can be 100% statically generated.</p></li><li class="TreeToJSX__Li-sc-1taxolb-2 dTmJnK"><p>Simplified architecture. No more databases and servers, just files served from GitHub Pages.</p></li><li class="TreeToJSX__Li-sc-1taxolb-2 dTmJnK"><p>Using Git as my &quot;CMS&quot;. Switching from storing blog posts in a database, to storing them in <code class="Code-sc-1amjnp4-0 iQzkww">.md</code> files, tracked by Git.</p></li></ol><h2>Choosing a React Static Site Generator</h2><p>Coming from a MERN app, I needed a SSG solution for React. I considered choosing between three different options:</p><ul><li class="TreeToJSX__Li-sc-1taxolb-2 dTmJnK"><p><a href="https://github.com/gatsbyjs/gatsby" target="_blank" rel="noopener noreferrer" class="A__A_-sc-14fqd0c-0 kuhBS">Gatsby</a></p></li><li class="TreeToJSX__Li-sc-1taxolb-2 dTmJnK"><p><a href="https://github.com/vercel/next.js" target="_blank" rel="noopener noreferrer" class="A__A_-sc-14fqd0c-0 kuhBS">Next.js</a></p></li><li class="TreeToJSX__Li-sc-1taxolb-2 dTmJnK"><p><a href="https://github.com/react-static/react-static" target="_blank" rel="noopener noreferrer" class="A__A_-sc-14fqd0c-0 kuhBS">React Static</a></p></li></ul><p>The two most popular React frameworks are Gatsby &amp; Next.js. Gatsby is a very powerful tool that emphasizes a plugin ecosystem. Gatsby can do a lot. As I went through Gatsby&#x27;s vast documentation, I was having difficulty figuring out how to do what I wanted to do, for my fairly simple use case. After this experience, I was drawn to the simplicity of React Static. Ultimately, I ended up choosing Next.js for a few different reasons, one being their documentation coupled with their collection of examples on GitHub. I used their <a href="https://github.com/vercel/next.js/tree/canary/examples/blog-starter" target="_blank" rel="noopener noreferrer" class="A__A_-sc-14fqd0c-0 kuhBS">blog-starter template</a> as a starting point. Another reason I chose Next is their great out-of-the-box TypeScript support.</p><p>The last minor thing that sealed the deal for my decision, was the React team announcing that they are collaborating with the Next.js team on React&#x27;s new experimental feature, &quot;Server Components&quot;. Relevant links:</p><ul><li class="TreeToJSX__Li-sc-1taxolb-2 dTmJnK"><p><a href="https://reactjs.org/blog/2020/12/21/data-fetching-with-react-server-components.html" target="_blank" rel="noopener noreferrer" class="A__A_-sc-14fqd0c-0 kuhBS">Introducing Zero-Bundle-Size React Server Components</a></p></li><li class="TreeToJSX__Li-sc-1taxolb-2 dTmJnK"><p><a href="https://youtu.be/TQQPAU21ZUw?t=2570" target="_blank" rel="noopener noreferrer" class="A__A_-sc-14fqd0c-0 kuhBS">(Timestamp in the talk where Dan Abramov mentions the Next.js collab)</a></p></li></ul><p>While not a huge factor, it gave me the impression that the design philosophies of Next.js and the React core team align the most closely, and that Next.js would be receiving first-class support for this feature.</p><h2>Migrating from MERN to JAM</h2><p>Source code can be found here:</p><ul><li class="TreeToJSX__Li-sc-1taxolb-2 dTmJnK"><p>Post-migration GitHub source: <a href="https://github.com/zzzachzzz/zzzachzzz.github.io/tree/master" target="_blank" rel="noopener noreferrer" class="A__A_-sc-14fqd0c-0 kuhBS">https://github.com/zzzachzzz/zzzachzzz.github.io/tree/master</a></p></li><li class="TreeToJSX__Li-sc-1taxolb-2 dTmJnK"><p>Pre-migration GitHub source: <a href="https://github.com/zzzachzzz/zzzachzzz.github.io/tree/2ab6f0b10606162a57b946461c4dae74e2a295d5" target="_blank" rel="noopener noreferrer" class="A__A_-sc-14fqd0c-0 kuhBS">https://github.com/zzzachzzz/zzzachzzz.github.io/tree/2ab6f0b10606162a57b946461c4dae74e2a295d5</a></p></li></ul><p>Aside from the usual steps to migrate a common React app to a Next.js React app, there were a few other things I needed to handle in the migration. There would be changes to accommodate for the removal of a server; no Express &amp; no MongoDB. There would also be some small changes to account for a React app utilizing SSG or SSR (server-side rendering), specifically the way CSS is loaded, depending on the tool you use for CSS.</p><h3>MongoDB to .md Files</h3><p>For moving the content from MongoDB to markdown files, I created a migration script: <a href="https://github.com/zzzachzzz/zzzachzzz.github.io/blob/fc62221055adea46ef43803c973b28445262c448/backend/migrations/db-to-markdown-file.js" target="_blank" rel="noopener noreferrer" class="A__A_-sc-14fqd0c-0 kuhBS">backend/migrations/db-to-markdown-file.js</a></p><h3>CSS for SSG / SSR</h3><p>Depending on which tool you use for CSS, Next.js documents how to use it in SSG &amp; SSR here: <a href="https://nextjs.org/docs/basic-features/built-in-css-support" target="_blank" rel="noopener noreferrer" class="A__A_-sc-14fqd0c-0 kuhBS">https://nextjs.org/docs/basic-features/built-in-css-support</a></p><p>From there, they link to examples on their GitHub. I use <code class="Code-sc-1amjnp4-0 iQzkww">styled-components</code>, so I followed their example here: <a href="https://github.com/vercel/next.js/tree/canary/examples/with-styled-components" target="_blank" rel="noopener noreferrer" class="A__A_-sc-14fqd0c-0 kuhBS">https://github.com/vercel/next.js/tree/canary/examples/with-styled-components</a></p><h3>Hosting a Static Site on GitHub Pages</h3><p>In addition to the <code class="Code-sc-1amjnp4-0 iQzkww">next build</code> script, to deploy a fully static site without a server, the <code class="Code-sc-1amjnp4-0 iQzkww">next export</code> script is used: <a href="https://nextjs.org/docs/advanced-features/static-html-export" target="_blank" rel="noopener noreferrer" class="A__A_-sc-14fqd0c-0 kuhBS">https://nextjs.org/docs/advanced-features/static-html-export</a></p><p>When hosting the static build on a git branch on GitHub Pages, the naming of the exported <code class="Code-sc-1amjnp4-0 iQzkww">_next/</code> directory triggers Jekyll on GitHub Pages, as directories with a leading underscore have a special meaning to Jekyll. This unexpected side effect resulted in 404s for certain static assets my site was trying to fetch. To disable Jekyll processing on GitHub pages, we need to provide a <code class="Code-sc-1amjnp4-0 iQzkww">.nojekyll</code> file at the root. This was my final build script in my <code class="Code-sc-1amjnp4-0 iQzkww">package.json</code> file:<br/><code class="Code-sc-1amjnp4-0 iQzkww">&quot;build&quot;: &quot;next build &amp;&amp; next export &amp;&amp; touch ./out/.nojekyll&quot;</code><br/>More info here: <a href="https://github.blog/2009-12-29-bypassing-jekyll-on-github-pages" target="_blank" rel="noopener noreferrer" class="A__A_-sc-14fqd0c-0 kuhBS">https://github.blog/2009-12-29-bypassing-jekyll-on-github-pages</a></p><p>While not mandatory, I do recommend the <a href="https://www.npmjs.com/package/gh-pages" target="_blank" rel="noopener noreferrer" class="A__A_-sc-14fqd0c-0 kuhBS">gh-pages</a> npm package if you do intend to deploy to GitHub Pages. By default it will push to a branch named <code class="Code-sc-1amjnp4-0 iQzkww">gh-pages</code>. You&#x27;ll want to configure your GitHub repo&#x27;s settings to serve GitHub Pages from this branch. In conjunction with the build script I mentioned above, this was my deploy script:<br/><code class="Code-sc-1amjnp4-0 iQzkww">&quot;deploy&quot;: &quot;yarn run build &amp;&amp; gh-pages --dist out --dotfiles&quot;</code><br/><code class="Code-sc-1amjnp4-0 iQzkww">out/</code> is the default output directory name for a Next.js static export, and we need to include the option <code class="Code-sc-1amjnp4-0 iQzkww">--dotfiles</code> for the <code class="Code-sc-1amjnp4-0 iQzkww">.nojekyll</code> file to be included in the push to the <code class="Code-sc-1amjnp4-0 iQzkww">gh-pages</code> branch.</p><h3>Getting Prism.js to Work with SSG / SSR</h3><p>I never found it straightforward to set up Prism.js for code highlighting in a React app. When my pages were still being rendered client-side, I used <code class="Code-sc-1amjnp4-0 iQzkww">React.useEffect</code> to trigger Prism to highlight all code blocks:</p><pre class="TreeToJSX__Pre-sc-1taxolb-0 fOgHwq  language-jsx"><code class="  language-jsx">React<span class="token punctuation">.</span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  Prism<span class="token punctuation">.</span><span class="token function">highlightAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>While I could still have the effect be performed client-side, I wanted to go all in on having my site be fully statically generated. In my <a href="https://github.com/zzzachzzz/zzzachzzz.github.io/blob/master/components/TreeToJSX.tsx" target="_blank" rel="noopener noreferrer" class="A__A_-sc-14fqd0c-0 kuhBS">TreeToJSX.tsx</a> component, responsible for rendering a markdown document tree to JSX, I came up with the following solution to have the Prism highlighted HTML be built:</p><pre class="TreeToJSX__Pre-sc-1taxolb-0 fOgHwq  language-tsx"><code class="  language-tsx"><span class="token comment">// Add leading whitespace to &lt;code> className due to className mismatch caused by Prism injecting class</span>
<span class="token keyword">const</span> <span class="token function-variable function">CodeBlock</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> lang<span class="token punctuation">,</span> children <span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{</span> lang<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">;</span> children<span class="token operator">:</span> string<span class="token punctuation">;</span> <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> langCls <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> language-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>lang <span class="token operator">||</span> <span class="token string">'none'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>lang<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> highlightedCode <span class="token operator">=</span> Prism<span class="token punctuation">.</span><span class="token function">highlight</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> Prism<span class="token punctuation">.</span>languages<span class="token punctuation">[</span>lang<span class="token punctuation">]</span><span class="token punctuation">,</span> lang<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Pre</span></span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>langCls<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>code</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token string">" "</span> <span class="token operator">+</span> langCls<span class="token punctuation">}</span></span> <span class="token attr-name">dangerouslySetInnerHTML</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>__html<span class="token operator">:</span> highlightedCode<span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>code</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Pre</span></span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Pre</span></span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>langCls<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>code</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token string">" "</span> <span class="token operator">+</span> langCls<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>code</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Pre</span></span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>Prism offers a low level <code class="Code-sc-1amjnp4-0 iQzkww">highlight</code> function that will return stringified HTML of the syntax highlighted code we provide in the string <code class="Code-sc-1amjnp4-0 iQzkww">children</code>. I was getting a warning about a mismatching className between the client and server (server in development, for SSG). The mismatch was caused by leading whitespace in one but not the other: <code class="Code-sc-1amjnp4-0 iQzkww">&quot; language-jsx&quot;</code> vs <code class="Code-sc-1amjnp4-0 iQzkww">&quot;language-jsx&quot;</code>. This was some oddity caused by the way Prism injects CSS classes, that I was able to workaround by adding leading whitespace to the class names.</p><h2>Hot Reloading a Rendered Blog Post Upon its Markdown File Being Edited</h2><p>I outline this feature in a separate post:<br/><a href="/blog/hot-reloading-blog-preview-on-markdown-file-edit" target="_self" rel="noopener noreferrer" class="A__A_-sc-14fqd0c-0 kuhBS">Hot Reloading Blog Preview on Markdown File Edit</a></p><p><img src="/assets/blog-hot-reload.gif" alt="Side by side web browser and vim hot reloading" class="TreeToJSX__Img-sc-1taxolb-3 jvwBiV"/></p></div></article></main></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"Going Truly Serverless with Next.js Static Site Generation","date":"2021-02-20T14:35:05.888Z","content":"\nWith the hype of the [Jamstack](https://jamstack.org), and the benefits it offers, I made the switch from MERN stack to JAM stack for my blog. The most appealing benefits to me in my use case were:\n1. Improved SEO, for my site that can be 100% statically generated.\n2. Simplified architecture. No more databases and servers, just files served from GitHub Pages.\n3. Using Git as my \"CMS\". Switching from storing blog posts in a database, to storing them in `.md` files, tracked by Git.\n\n## Choosing a React Static Site Generator\n\nComing from a MERN app, I needed a SSG solution for React. I considered choosing between three different options:\n* [Gatsby](https://github.com/gatsbyjs/gatsby)\n* [Next.js](https://github.com/vercel/next.js)\n* [React Static](https://github.com/react-static/react-static)\n\nThe two most popular React frameworks are Gatsby \u0026 Next.js. Gatsby is a very powerful tool that emphasizes a plugin ecosystem. Gatsby can do a lot. As I went through Gatsby's vast documentation, I was having difficulty figuring out how to do what I wanted to do, for my fairly simple use case. After this experience, I was drawn to the simplicity of React Static. Ultimately, I ended up choosing Next.js for a few different reasons, one being their documentation coupled with their collection of examples on GitHub. I used their [blog-starter template](https://github.com/vercel/next.js/tree/canary/examples/blog-starter) as a starting point. Another reason I chose Next is their great out-of-the-box TypeScript support.\n\nThe last minor thing that sealed the deal for my decision, was the React team announcing that they are collaborating with the Next.js team on React's new experimental feature, \"Server Components\". Relevant links:\n* [Introducing Zero-Bundle-Size React Server Components](https://reactjs.org/blog/2020/12/21/data-fetching-with-react-server-components.html)\n* [(Timestamp in the talk where Dan Abramov mentions the Next.js collab)](https://youtu.be/TQQPAU21ZUw?t=2570)\n\nWhile not a huge factor, it gave me the impression that the design philosophies of Next.js and the React core team align the most closely, and that Next.js would be receiving first-class support for this feature.\n\n## Migrating from MERN to JAM\nSource code can be found here:\n* Post-migration GitHub source: \u003chttps://github.com/zzzachzzz/zzzachzzz.github.io/tree/master\u003e\n* Pre-migration GitHub source: \u003chttps://github.com/zzzachzzz/zzzachzzz.github.io/tree/2ab6f0b10606162a57b946461c4dae74e2a295d5\u003e\n\nAside from the usual steps to migrate a common React app to a Next.js React app, there were a few other things I needed to handle in the migration. There would be changes to accommodate for the removal of a server; no Express \u0026 no MongoDB. There would also be some small changes to account for a React app utilizing SSG or SSR (server-side rendering), specifically the way CSS is loaded, depending on the tool you use for CSS.\n\n### MongoDB to .md Files\nFor moving the content from MongoDB to markdown files, I created a migration script: [backend/migrations/db-to-markdown-file.js](https://github.com/zzzachzzz/zzzachzzz.github.io/blob/fc62221055adea46ef43803c973b28445262c448/backend/migrations/db-to-markdown-file.js)\n\n### CSS for SSG / SSR\nDepending on which tool you use for CSS, Next.js documents how to use it in SSG \u0026 SSR here: \u003chttps://nextjs.org/docs/basic-features/built-in-css-support\u003e\n\nFrom there, they link to examples on their GitHub. I use `styled-components`, so I followed their example here: \u003chttps://github.com/vercel/next.js/tree/canary/examples/with-styled-components\u003e\n\n### Hosting a Static Site on GitHub Pages\nIn addition to the `next build` script, to deploy a fully static site without a server, the `next export` script is used: \u003chttps://nextjs.org/docs/advanced-features/static-html-export\u003e\n\nWhen hosting the static build on a git branch on GitHub Pages, the naming of the exported `_next/` directory triggers Jekyll on GitHub Pages, as directories with a leading underscore have a special meaning to Jekyll. This unexpected side effect resulted in 404s for certain static assets my site was trying to fetch. To disable Jekyll processing on GitHub pages, we need to provide a `.nojekyll` file at the root. This was my final build script in my `package.json` file:  \n`\"build\": \"next build \u0026\u0026 next export \u0026\u0026 touch ./out/.nojekyll\"`  \nMore info here: \u003chttps://github.blog/2009-12-29-bypassing-jekyll-on-github-pages\u003e\n\nWhile not mandatory, I do recommend the [gh-pages](https://www.npmjs.com/package/gh-pages) npm package if you do intend to deploy to GitHub Pages. By default it will push to a branch named `gh-pages`. You'll want to configure your GitHub repo's settings to serve GitHub Pages from this branch. In conjunction with the build script I mentioned above, this was my deploy script:  \n`\"deploy\": \"yarn run build \u0026\u0026 gh-pages --dist out --dotfiles\"`  \n`out/` is the default output directory name for a Next.js static export, and we need to include the option `--dotfiles` for the `.nojekyll` file to be included in the push to the `gh-pages` branch.\n\n### Getting Prism.js to Work with SSG / SSR\nI never found it straightforward to set up Prism.js for code highlighting in a React app. When my pages were still being rendered client-side, I used `React.useEffect` to trigger Prism to highlight all code blocks:\n```jsx\nReact.useEffect(() =\u003e {\n  Prism.highlightAll();\n}, []);\n```\nWhile I could still have the effect be performed client-side, I wanted to go all in on having my site be fully statically generated. In my [TreeToJSX.tsx](https://github.com/zzzachzzz/zzzachzzz.github.io/blob/master/components/TreeToJSX.tsx) component, responsible for rendering a markdown document tree to JSX, I came up with the following solution to have the Prism highlighted HTML be built:\n```tsx\n// Add leading whitespace to \u003ccode\u003e className due to className mismatch caused by Prism injecting class\nconst CodeBlock = ({ lang, children }: { lang?: string; children: string; }) =\u003e {\n  const langCls = ` language-${lang || 'none'}`;\n  if (lang) {\n    const highlightedCode = Prism.highlight(children, Prism.languages[lang], lang);\n    return (\n      \u003cPre className={langCls}\u003e\n        \u003ccode className={\" \" + langCls} dangerouslySetInnerHTML={{__html: highlightedCode}}\u003e\u003c/code\u003e\n      \u003c/Pre\u003e\n    );\n  } else {\n    return (\n      \u003cPre className={langCls}\u003e\n        \u003ccode className={\" \" + langCls}\u003e{children}\u003c/code\u003e\n      \u003c/Pre\u003e\n    );\n  }\n};\n```\nPrism offers a low level `highlight` function that will return stringified HTML of the syntax highlighted code we provide in the string `children`. I was getting a warning about a mismatching className between the client and server (server in development, for SSG). The mismatch was caused by leading whitespace in one but not the other: `\" language-jsx\"` vs `\"language-jsx\"`. This was some oddity caused by the way Prism injects CSS classes, that I was able to workaround by adding leading whitespace to the class names.\n\n## Hot Reloading a Rendered Blog Post Upon its Markdown File Being Edited\n\nI outline this feature in a separate post:  \n[Hot Reloading Blog Preview on Markdown File Edit](/blog/hot-reloading-blog-preview-on-markdown-file-edit)\n\n![Side by side web browser and vim hot reloading](/assets/blog-hot-reload.gif)\n\n","slug":"going-truly-serverless-with-nextjs-static-site-generation"}},"__N_SSG":true},"page":"/blog/[slug]","query":{"slug":"going-truly-serverless-with-nextjs-static-site-generation"},"buildId":"A9cKA_zhYD1VSqmOQ4PvN","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-28654a8145d7603786fc.js"></script><script src="/_next/static/chunks/main-c746a4ce4ff8692382cd.js" async=""></script><script src="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" async=""></script><script src="/_next/static/chunks/framework.37f4a736348214b3ca94.js" async=""></script><script src="/_next/static/chunks/commons.e810983d220ce60d77fa.js" async=""></script><script src="/_next/static/chunks/d31217defe14a45f21f2dc88a0340a4400241e5c.43128fe35357df1292f1.js" async=""></script><script src="/_next/static/chunks/pages/_app-c5083ace283475b900f0.js" async=""></script><script src="/_next/static/chunks/f55490c27d84c973f151130575d86126183b0b6b.3b39966ad3ab6ba53dac.js" async=""></script><script src="/_next/static/chunks/14e8b4443f853547963f3fff4f6d87edb6a6aabe.7f99b8b5b085a064ffe9.js" async=""></script><script src="/_next/static/chunks/pages/blog/%5Bslug%5D-3e90714ce7440c4a9cbd.js" async=""></script><script src="/_next/static/A9cKA_zhYD1VSqmOQ4PvN/_buildManifest.js" async=""></script><script src="/_next/static/A9cKA_zhYD1VSqmOQ4PvN/_ssgManifest.js" async=""></script></body></html>